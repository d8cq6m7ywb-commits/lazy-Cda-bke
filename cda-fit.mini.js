function switchUnit(){calculateResult()}function showWarning(e){let t=document.getElementById("warn");t.textContent=e,t.style.display="block"}function clearWarning(){let e=document.getElementById("warn");e.style.display="none",e.textContent=""}function calculateResult(){clearWarning();let e=document.getElementById("unit").value,t=document.getElementById("pmLocation").value,l=+document.getElementById("altitude").value||0,n=+document.getElementById("tempC").value||0,a=document.getElementById("rhPct").value,r=""===a?null:Math.min(Math.max(+a,0),100),i=+document.getElementById("pOverride").value,d=+document.getElementById("rider-weight-kg").value||0,o=+document.getElementById("clothes-gear-kg").value||0,s=+document.getElementById("bike-weight-kg").value||0,u=+document.getElementById("distance-km").value||1,m=+document.getElementById("total-climb-m").value||0,c=+document.getElementById("wind-kmh").value||0;"imperial"===e&&(d/=2.20462,o/=2.20462,s/=2.20462,u*=1.60934,m/=3.28084,c*=1.60934);let $=(+document.getElementById("hh").value||0)+(+document.getElementById("mm").value||0)/60+(+document.getElementById("ss").value||0)/3600;$=Math.max($,1e-4);let g=+document.getElementById("power").value||0,p=+document.getElementById("crr_rolling").value||.0036,f=(+document.getElementById("driveTrainEfficiency").value||98)/100,y=u/$,h=y*(1e3/3600),E=Math.max(0,h+c/3.6),b=d+o+s,I=m/(1e3*u),x=n+273.15,_=i>0?100*i:101325*Math.pow(1-.0065*l/288.15,9.80665*.0289652/.054044007017),v=.0289652*_/(8.314462618*x);if(null!==r){let B=100*(6.1094*Math.exp(17.625*n/(n+243.04))),F=Math.min(B,Math.max(0,r/100*B));v=Math.max(0,_-F)/(287.058*x)+F/(461.495*x)}let w=("crank"===t?g*f:g)-9.80665*b*p*(1/Math.sqrt(1+I*I))*h-9.80665*b*I*h,C=.5*v*E*E*h;C<=0||w<=0?(document.getElementById("cda").textContent="—",showWarning("Infeasible inputs: aero power ≤ 0 (or zero airspeed). Check wind sign, climb, Crr, power, and time/distance.")):document.getElementById("cda").textContent=(w/C).toFixed(3),document.getElementById("speed").textContent=`${y.toFixed(2)} ${"imperial"===e?"mph":"km/h"}`,document.getElementById("slopeGrade").textContent=(100*I).toFixed(4)+" %",document.getElementById("rhoUsed").textContent=`${v.toFixed(4)} kg/m\xb3`,document.getElementById("pressureUsed").textContent=`${(_/100).toFixed(1)} hPa`}function resetValues(){document.getElementById("unit").value="metric",document.getElementById("pmLocation").value="crank",document.getElementById("altitude").value=100,document.getElementById("tempC").value=20,document.getElementById("rhPct").value="",document.getElementById("pOverride").value="",document.getElementById("rider-weight-kg").value=70,document.getElementById("clothes-gear-kg").value=1,document.getElementById("bike-weight-kg").value=9,document.getElementById("distance-km").value=30,document.getElementById("total-climb-m").value=0,document.getElementById("wind-kmh").value=0,document.getElementById("power").value=180,document.getElementById("crr_rolling").value=.0036,document.getElementById("driveTrainEfficiency").value=98,document.getElementById("hh").value=1,document.getElementById("mm").value=0,document.getElementById("ss").value=0,clearWarning(),calculateResult()}function getEnvParamsForSamples(){let e=document.getElementById("unit").value,t=document.getElementById("pmLocation").value,l=+document.getElementById("altitude").value||0,n=+document.getElementById("tempC").value||0,a=document.getElementById("rhPct").value,r=""===a?null:Math.min(Math.max(+a,0),100),i=+document.getElementById("pOverride").value,d=+document.getElementById("rider-weight-kg").value||0,o=+document.getElementById("clothes-gear-kg").value||0,s=+document.getElementById("bike-weight-kg").value||0,u=+document.getElementById("wind-kmh").value||0,m=+document.getElementById("crr_rolling").value||.0036,c=(+document.getElementById("driveTrainEfficiency").value||98)/100;"imperial"===e&&(d/=2.20462,o/=2.20462,s/=2.20462,u*=1.60934);let $=d+o+s,g=n+273.15,p=i>0?100*i:101325*Math.pow(1-.0065*l/288.15,9.80665*.0289652/.054044007017),f=.0289652*p/(8.314462618*g);if(null!==r){let y=100*(6.1094*Math.exp(17.625*n/(n+243.04))),h=Math.min(y,Math.max(0,r/100*y));f=Math.max(0,p-h)/(287.058*g)+h/(461.495*g)}let E=u/3.6;return{rho:f,totalMass:$,crr:m,g:9.80665,windMs:E,powerAtWheelFactor:"crank"===t?c:1}}document.addEventListener("DOMContentLoaded",function(){resetValues();let e=document.getElementById("fitFileInput");e&&e.addEventListener("change",handleFitFileSelect);let t=document.getElementById("analysisMode");t&&t.addEventListener("change",syncLapCheckboxMode)});let currentFitData=null,fitScatterChart=null;function resolveFitParserCtor(){let e=window,t=e.FitParser,l=e.FIT&&e.FIT.FitParser,n="function"==typeof t?t:"function"==typeof l?l:null;return n||console.error("FitParser global not found on window:",{FitParser:e.FitParser,FIT:e.FIT}),n}function handleFitFileSelect(e){let t=e.target.files&&e.target.files[0],l=document.getElementById("fitStatus"),n=document.getElementById("lapTableBody"),a=document.getElementById("fitSummary"),r=document.getElementById("fitStatsTable"),i=document.getElementById("fitStatsBody");if(n&&(n.innerHTML=""),a&&(a.textContent=""),i&&(i.innerHTML=""),r&&(r.style.display="none"),!t){l.textContent="",currentFitData=null;return}let d=resolveFitParserCtor();if(!d){l.textContent="FIT parser not found (bundle.js).",currentFitData=null;return}l.textContent=`Reading ${t.name}…`;let o=new FileReader;o.onload=function(e){let t=e.target.result;try{let n=new d({force:!0,speedUnit:"m/s",lengthUnit:"m",temperatureUnit:"celsius",mode:"cascade",elapsedRecordField:!0});n.parse(t,function(e,t){if(e){console.error(e),l.textContent="Error parsing FIT file.",currentFitData=null;return}currentFitData=normaliseFitDataFromFitParser(t),l.textContent=`Parsed ${currentFitData.records.length} records, ${currentFitData.laps.length} laps.`,renderLapTable(currentFitData.laps),syncLapCheckboxMode()})}catch(a){console.error(a),l.textContent="Exception while parsing FIT file.",currentFitData=null}},o.onerror=function(){l.textContent="Error reading file.",currentFitData=null},o.readAsArrayBuffer(t)}function toNumber(e){let t="object"==typeof e&&null!==e&&"value"in e?e.value:e,l=Number(t);return isFinite(l)?l:null}function normaliseRecord(e){let t=toNumber(e.speed)??toNumber(e.enhanced_speed)??null,l=toNumber(e.distance)??toNumber(e.total_distance)??null,n=toNumber(e.altitude)??toNumber(e.enhanced_altitude)??null,a=toNumber(e.power)??0,r=toNumber(e.cadence),i=e.timestamp?new Date(e.timestamp):null;return{t:i,distance:l,speed:t,altitude:n,power:a,cadence:r,grade:0}}function addGradeFromAlt(e){if(e&&!(e.length<2)){for(let t=1;t<e.length;t++){let l=e[t-1],n=e[t],a=null!=n.distance&&null!=l.distance?n.distance-l.distance:0,r=null!=n.altitude&&null!=l.altitude?n.altitude-l.altitude:0;n.grade=a>1?r/a:0}e[0].grade=e[1].grade}}function normaliseFitDataFromFitParser(e){let t=[];!function e(t,l){if(t&&"object"==typeof t){if(Array.isArray(t)){for(let n of t)e(n,l);return}for(let a in t){if(!Object.prototype.hasOwnProperty.call(t,a))continue;let r=t[a];("records"===a||"record"===a)&&Array.isArray(r)?l.push(...r):e(r,l)}}}(e,t);let l=t.map(normaliseRecord);function n(e){return!!e&&"object"==typeof e&&("total_distance"in e||"total_timer_distance"in e)&&("total_timer_time"in e||"start_time"in e||"timestamp"in e)}l.length&&addGradeFromAlt(l);let a=[];!function e(t,l){if(t&&"object"==typeof t){if(Array.isArray(t)){for(let a of t)e(a,l);return}for(let r in t){if(!Object.prototype.hasOwnProperty.call(t,r))continue;let i=t[r];Array.isArray(i)&&("laps"===r||"lap"===r)?i.forEach(e=>{n(e)&&l.push(e)}):"object"==typeof i&&i&&e(i,l)}}}(e,a);let r=[];if(l.length){if(a.length>=1){let i=a.map(e=>{let t=e.start_time||e.timestamp||null,l=t?new Date(t):null,n=toNumber(e.total_timer_time),a=null;l&&null!=n&&(a=new Date(l.getTime()+1e3*n));let r=toNumber(e.total_distance)??toNumber(e.total_timer_distance)??null,i=toNumber(e.avg_speed)??null,d=toNumber(e.avg_power)??null;return{start:l,end:a,totalDistance:r,totalTimerTime:n,avgSpeed:i,avgPower:d}}).filter(e=>e.start);i.sort((e,t)=>e.start-t.start);for(let d=0;d<i.length;d++)if(!i[d].end){let o=i[d+1];o&&o.start&&(i[d].end=new Date(o.start.getTime()-1e3))}let s=l.length?l[l.length-1].t:null,u=i[i.length-1];u&&!u.end&&s&&(u.end=s),r=i.map((e,t)=>{let n=l.filter(t=>t.t&&e.start&&e.end&&t.t>=e.start&&t.t<=e.end),a=e.totalDistance;if(n.length&&null==a){let r=n[0].distance,i=n[n.length-1].distance;null!=i&&(a=null!=r&&i>=r?i-r:i)}let d=e.totalTimerTime;if(n.length&&(!isFinite(d)||null==d)){let o=n[0].t,s=n[n.length-1].t;o&&s&&(d=(s-o)/1e3)}let u=e.avgPower;if(n.length&&(!isFinite(u)||null==u)){let m=0,c=0;for(let $ of n)null!=$.power&&isFinite($.power)&&(m+=$.power,c++);u=c?m/c:null}let g=e.avgSpeed;return(null==g||!isFinite(g))&&d&&a&&(g=a/d),{index:t,displayIndex:t+1,use:!0,totalDistance:a,totalTimerTime:d,avgSpeed:g,avgPower:u,records:n}}).filter(e=>e.records.length>0)}if(!r.length){let m=l[0],c=l[l.length-1],$=null;null!=c.distance&&($=null!=m.distance&&c.distance>=m.distance?c.distance-m.distance:c.distance);let g=null;m.t&&c.t&&(g=(c.t-m.t)/1e3);let p=0,f=0;for(let y of l)null!=y.power&&isFinite(y.power)&&(p+=y.power,f++);let h=f?p/f:null;r.push({index:0,displayIndex:1,use:!0,totalDistance:$,totalTimerTime:g,avgSpeed:null,avgPower:h,records:l})}}return{laps:r,records:l}}function renderLapTable(e){let t=document.getElementById("lapTableBody");if(!t)return;if(t.innerHTML="",!e||!e.length){let l=document.createElement("tr"),n=document.createElement("td");n.colSpan=6,n.textContent="No laps found in file.",n.style.textAlign="center",l.appendChild(n),t.appendChild(l);return}let a=Math.max(...e.map(e=>e.totalDistance||0));e.forEach(e=>{let l=document.createElement("tr"),n=null!=e.totalDistance?e.totalDistance/1e3:null,r=null!=e.totalTimerTime?e.totalTimerTime/60:null,i=!a||e.totalDistance&&e.totalDistance>.3*a,d=null;null!=n&&null!=r&&r>.01?d=n/(r/60):null!=e.avgSpeed&&(d=3.6*e.avgSpeed),l.innerHTML=`
      <td>${e.displayIndex}</td>
      <td><input type="checkbox" class="lap-use" data-lap-index="${e.index}" ${i?"checked":""}></td>
      <td>${null!=n?n.toFixed(2):"–"}</td>
      <td>${null!=r?r.toFixed(1):"–"}</td>
      <td>${null!=d&&isFinite(d)?d.toFixed(1)+" km/h":"–"}</td>
      <td>${null!=e.avgPower?e.avgPower.toFixed(0)+" W":"–"}</td>
    `,t.appendChild(l)})}function syncLapCheckboxMode(){let e=document.getElementById("analysisMode");if(!e)return;let t=e.value,l=document.querySelectorAll(".lap-use");l.forEach(e=>{"race"===t?(e.checked=!0,e.disabled=!0):e.disabled=!1})}function runFitAnalysis(){let e=document.getElementById("fitStatus"),t=document.getElementById("fitSummary"),l=document.getElementById("fitStatsTable"),n=document.getElementById("fitStatsBody");if(!currentFitData){e.textContent="No FIT file parsed yet.";return}let a=document.getElementById("analysisMode").value,r=getEnvParamsForSamples(),i=[];if("laps"===a){let d=document.querySelectorAll(".lap-use"),o=new Set;d.forEach(e=>{if(e.checked){let t=Number(e.getAttribute("data-lap-index"));o.add(t)}}),currentFitData.laps.forEach(e=>{o.has(e.index)&&i.push(...e.records)})}else i=currentFitData.records.slice();if(!i.length){e.textContent="No records in selected laps.";return}let s=analyseCdAFromRecords(i,r,{minSpeedKmh:10,maxSpeedKmh:65,minPowerW:80,maxPowerW:900,maxAbsGrade:.06,minCdA:.1,maxCdA:.5});renderFitAnalysis(s,t,l,n),e.textContent=`Used ${s.countAll} samples after filtering.`,renderFitScatter(s.points)}function isUsableRecord(e,t){if(null==e.speed||null==e.power)return!1;let l=3.6*e.speed,n=e.power,a=e.grade||0;return!(!isFinite(l)||l<t.minSpeedKmh||l>t.maxSpeedKmh||!isFinite(n)||n<t.minPowerW||n>t.maxPowerW||!isFinite(a)||Math.abs(a)>t.maxAbsGrade)}function computeCdAForRecord(e,t){let l=e.speed,n=Math.max(0,l+t.windMs);if(l<=0||n<=0)return NaN;let a=e.grade||0,r=t.totalMass,i=t.g,d=t.crr,o=t.powerAtWheelFactor*e.power,s=o-i*r*d*(1/Math.sqrt(1+a*a))*l-i*r*a*l,u=.5*t.rho*n*n*l;return u<=0||s<=0?NaN:s/u}function analyseCdAFromRecords(e,t,l){let n=[],a=[],r=[],i=[];for(let d of e){if(!isUsableRecord(d,l))continue;let o=computeCdAForRecord(d,t);if(!isFinite(o)||o<l.minCdA||o>l.maxCdA)continue;let s=3.6*d.speed,u=d.grade||0,m=Math.abs(u),c=m<=.01?"race":u>=.02?"climb":"other";n.push(o),"race"===c&&a.push({cda:o,v_kmh:s}),"climb"===c&&r.push({cda:o,v_kmh:s}),i.length<4e3&&i.push({cda:o,v_kmh:s,cat:c})}function $(e){if(!e.length)return{n:0,median:null,p25:null,p75:null};let t=e.map(e=>e.cda).slice().sort((e,t)=>e-t),l=t.length,n=t[Math.floor(.5*l)],a=t[Math.floor(.25*l)],r=t[Math.floor(.75*l)];return{n:l,median:n,p25:a,p75:r}}let g=$(n.map(e=>({cda:e}))),p=$(a),f=$(r);function y(e,t){let l=e.filter(e=>e.v_kmh>=t);return l.length?$(l):{n:0,median:null,p25:null,p75:null}}let h=y(a,24),E=y(a,30),b=y(a,35),I=y(a,40),x=y(r,24);return{countAll:n.length,allSummary:g,raceSummary:p,climbSummary:f,raceHigh24:h,raceHigh30:E,raceHigh35:b,raceHigh40:I,climbHigh:x,points:i}}function renderFitAnalysis(e,t,l,n){function a(e,t){return null!=e&&isFinite(e)?e.toFixed(t):"–"}if(!e||!e.countAll){t.textContent="No usable samples after filtering.",l.style.display="none",n.innerHTML="";return}let r=e.raceHigh24.median??e.raceSummary.median,i=e.climbHigh.median??e.climbSummary.median;t.innerHTML=`Estimated <strong>racing CdA</strong> (flat, ≥24 km/h where available): <strong>${a(r,3)}</strong><br>Estimated <strong>climbing / relaxed CdA</strong>: <strong>${a(i,3)}</strong><br><span style="font-size:0.9em;color:#555;">${e.countAll} samples used after filtering. Race flat samples: ${e.raceSummary.n}, climb samples: ${e.climbSummary.n}.</span>`;let d=[{label:"All usable",s:e.allSummary,note:"all grades"},{label:"Race / flat",s:e.raceSummary,note:"|grade| ≤ 1%"},{label:"Race / flat, ≥24 km/h",s:e.raceHigh24,note:"subset of race"},{label:"Race / flat, ≥30 km/h",s:e.raceHigh30,note:"subset of race"},{label:"Race / flat, ≥35 km/h",s:e.raceHigh35,note:"subset of race"},{label:"Race / flat, ≥40 km/h",s:e.raceHigh40,note:"subset of race"},{label:"Climb / relaxed",s:e.climbSummary,note:"grade ≥ 2%"},{label:"Climb / relaxed, ≥24 km/h",s:e.climbHigh,note:"subset of climb"}];n.innerHTML="",d.forEach(e=>{let t=document.createElement("tr");t.innerHTML=`
      <td>${e.label}</td>
      <td>${e.s.n}</td>
      <td>${a(e.s.median,3)}</td>
      <td>${a(e.s.p25,3)} – ${a(e.s.p75,3)}</td>
      <td>${e.note}</td>
    `,n.appendChild(t)}),l.style.display="table"}function renderFitScatter(e){let t=document.getElementById("fitScatter");if(!t||!t.getContext)return;let l=t.getContext("2d"),n=e.filter(e=>"race"===e.cat).map(e=>({x:e.v_kmh,y:e.cda})),a=e.filter(e=>"climb"===e.cat).map(e=>({x:e.v_kmh,y:e.cda}));fitScatterChart&&fitScatterChart.destroy(),fitScatterChart=new Chart(l,{type:"scatter",data:{datasets:[{label:"Race / flat",data:n,pointRadius:2},{label:"Climb / relaxed",data:a,pointRadius:2}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{x:{type:"linear",title:{display:!0,text:"Speed (km/h)"},ticks:{stepSize:5}},y:{title:{display:!0,text:"CdA"},suggestedMin:.15,suggestedMax:.5}},plugins:{legend:{position:"top"},tooltip:{callbacks:{label(e){let t=e.parsed.x,l=e.parsed.y;return` ${t.toFixed(1)} km/h, CdA ${l.toFixed(3)}`}}}}}})}